<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joy Mouth Admin - Premium</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2ecc71; --bg: #f4f7f6; --card-bg: #ffffff; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 20px 30px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .order-card { background: var(--card-bg); border-radius: 24px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.04); border: 1px solid #edf2f7; transition: 0.3s; position: relative; overflow: hidden; }
        .order-card.new-order::before { content: '–®–ò–ù–≠'; position: absolute; top: 10px; right: -30px; background: #e74c3c; color: white; padding: 5px 40px; transform: rotate(45deg); font-size: 10px; font-weight: 800; }
        .status-badge { padding: 6px 14px; border-radius: 12px; font-size: 11px; font-weight: 800; }
        .items-list { background: #f8fafc; padding: 15px; border-radius: 15px; margin: 15px 0; }
        .total { font-size: 22px; font-weight: 800; color: var(--primary); text-align: right; }
        select { width: 100%; padding: 12px; border-radius: 12px; border: 1.5px solid #e2e8f0; font-family: inherit; font-weight: 600; cursor: pointer; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
        button.login-btn { padding: 15px 30px; font-size: 16px; font-weight: 800; background: #4285F4; color: white; border: none; border-radius: 12px; cursor: pointer; }
    </style>
</head>
<body>

<div id="login-overlay" style="display: none;">
    <h2>Joy Mouth Admin</h2>
    <p>–ê–¥–º–∏–Ω —ç—Ä—Ö—ç—ç—Ä –Ω—ç–≤—Ç—ç—Ä–Ω—ç “Ø“Ø</p>
    <button class="login-btn" onclick="adminLogin()">Google-—ç—ç—Ä –Ω—ç–≤—Ç—Ä—ç—Ö</button>
</div>

<audio id="orderSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<div class="header">
    <h1 style="margin: 0; font-weight: 800;">üë®‚Äçüç≥ Joy Mouth Admin</h1>
    <div id="stats" style="font-weight: 800; color: var(--primary); background: #f0fdf4; padding: 10px 20px; border-radius: 15px;">
        –ù–∏–π—Ç: <span id="count">0</span>
        <button onclick="firebase.auth().signOut()" style="margin-left: 10px; border: none; background: none; cursor: pointer; font-size: 12px; color: #666;">–ì–∞—Ä–∞—Ö</button>
    </div>
</div>

<div class="grid" id="admin-orders"></div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDpVh6TB0eVPHhoXjDHfxJuMjnkYnvlwRM",
        authDomain: "joymouth-e0898.firebaseapp.com",
        projectId: "joymouth-e0898",
        storageBucket: "joymouth-e0898.firebasestorage.app",
        messagingSenderId: "716037708846",
        appId: "1:716037708846:web:22691690cb8f214cfb13bf"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let firstLoad = true;

    // –ù—ç–≤—Ç—Ä—ç–ª—Ç–∏–π–Ω —Ç”©–ª”©–≤ —Ö—è–Ω–∞—Ö
    auth.onAuthStateChanged(user => {
        if (user && user.email === "g.anar1202@gmail.com") {
            document.getElementById('login-overlay').style.display = 'none';
            startListening();
        } else {
            document.getElementById('login-overlay').style.display = 'flex';
            if (user) {
                Swal.fire("–ê–¥–º–∏–Ω –±–∏—à", `${user.email} —Ö–∞—è–≥ –∞–¥–º–∏–Ω —ç—Ä—Ö–≥“Ø–π –±–∞–π–Ω–∞.`, "error");
                auth.signOut();
            }
        }
    });

    function adminLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider);
    }

    function startListening() {
        db.collection("orders").orderBy("createdAt", "desc").onSnapshot(snapshot => {
            const list = document.getElementById('admin-orders');
            document.getElementById('count').innerText = snapshot.size;
            
            if (!firstLoad && snapshot.docChanges().some(c => c.type === "added")) {
                document.getElementById('orderSound').play();
            }
            firstLoad = false;

            list.innerHTML = "";
            snapshot.forEach(doc => {
                const data = doc.data();
                const card = document.createElement('div');
                card.className = `order-card ${data.status === '–®–∏–Ω—ç' ? 'new-order' : ''}`;
                
                let itemsHtml = Object.entries(data.items).map(([n, q]) => 
                    `<div style="display:flex; justify-content:space-between; font-size:14px; margin-bottom:5px;"><span>${n}</span> <b>x${q}</b></div>`
                ).join('');
                
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div>
                            <div style="font-weight:800; font-size:16px;">${data.userName}</div>
                            <div style="font-size:12px; color:#64748b;">üïí ${data.createdAt?.toDate().toLocaleTimeString()}</div>
                        </div>
                        <span class="status-badge" style="background:${getStatusColor(data.status)}; color:white;">${data.status}</span>
                    </div>
                    <div style="margin: 15px 0; font-size:13px;">üìç ${data.address} <br> üìû ${data.userPhone}</div>
                    <div class="items-list">${itemsHtml}</div>
                    <div class="total">${(data.totalPrice || 0).toLocaleString()}‚ÇÆ</div>
                    <div style="margin-top:15px;">
                        <select onchange="updateStatus('${doc.id}', this.value)">
                            <option value="–®–∏–Ω—ç" ${data.status === '–®–∏–Ω—ç' ? 'selected' : ''}>–®–∏–Ω—ç</option>
                            <option value="–¢”©–ª–±”©—Ä —Ö“Ø–ª—ç—ç–≥–¥—ç–∂ –±–∞–π–Ω–∞" ${data.status === '–¢”©–ª–±”©—Ä —Ö“Ø–ª—ç—ç–≥–¥—ç–∂ –±–∞–π–Ω–∞' ? 'selected' : ''}>–¢”©–ª–±”©—Ä —Ö“Ø–ª—ç—ç–≥–¥—ç–∂ –±–∞–π–Ω–∞</option>
                            <option value="–ë—ç–ª—Ç–≥—ç–≥–¥—ç–∂ –±–∞–π–Ω–∞" ${data.status === '–ë—ç–ª—Ç–≥—ç–≥–¥—ç–∂ –±–∞–π–Ω–∞' ? 'selected' : ''}>–ë—ç–ª—Ç–≥—ç–≥–¥—ç–∂ –±–∞–π–Ω–∞</option>
                            <option value="–•“Ø—Ä–≥—ç–ª—Ç—ç–Ω–¥ –≥–∞—Ä—Å–∞–Ω" ${data.status === '–•“Ø—Ä–≥—ç–ª—Ç—ç–Ω–¥ –≥–∞—Ä—Å–∞–Ω' ? 'selected' : ''}>–•“Ø—Ä–≥—ç–ª—Ç—ç–Ω–¥ –≥–∞—Ä—Å–∞–Ω</option>
                            <option value="–•“Ø—Ä–≥—ç–≥–¥—Å—ç–Ω" ${data.status === '–•“Ø—Ä–≥—ç–≥–¥—Å—ç–Ω' ? 'selected' : ''}>–•“Ø—Ä–≥—ç–≥–¥—Å—ç–Ω</option>
                            <option value="–¶—É—Ü–ª–∞–≥–¥—Å–∞–Ω" ${data.status === '–¶—É—Ü–ª–∞–≥–¥—Å–∞–Ω' ? 'selected' : ''}>–¶—É—Ü–ª–∞–≥–¥—Å–∞–Ω</option>
                        </select>
                    </div>
                `;
                list.appendChild(card);
            });
        }, (error) => {
            console.error("Firestore Error:", error);
            if (error.code === 'permission-denied') {
                Swal.fire("–≠—Ä—Ö–≥“Ø–π —ç—Å–≤—ç–ª –ò–Ω–¥–µ–∫—Å “Ø“Ø—Å—ç—ç–≥“Ø–π", "Console (F12) –¥—ç—Ö –ª–∏–Ω–∫ –¥—ç—ç—Ä –¥–∞—Ä–∂ –ò–Ω–¥–µ–∫—Å “Ø“Ø—Å–≥—ç–Ω—ç “Ø“Ø.", "warning");
            }
        });
    }

    function getStatusColor(s) {
        const colors = { "–®–∏–Ω—ç": "#f39c12", "–ë—ç–ª—Ç–≥—ç–≥–¥—ç–∂ –±–∞–π–Ω–∞": "#9b59b6", "–•“Ø—Ä–≥—ç–ª—Ç—ç–Ω–¥ –≥–∞—Ä—Å–∞–Ω": "#e67e22", "–•“Ø—Ä–≥—ç–≥–¥—Å—ç–Ω": "#2ecc71", "–¶—É—Ü–ª–∞–≥–¥—Å–∞–Ω": "#e74c3c", "–¢”©–ª–±”©—Ä —Ö“Ø–ª—ç—ç–≥–¥—ç–∂ –±–∞–π–Ω–∞": "#3498db" };
        return colors[s] || "#95a5a6";
    }

    function updateStatus(id, s) {
        db.collection("orders").doc(id).update({ status: s })
            .then(() => Swal.fire({ title: '–¢”©–ª”©–≤ —à–∏–Ω—ç—á–ª—ç–≥–¥–ª—ç—ç', icon: 'success', timer: 1000, showConfirmButton: false, toast: true, position: 'top-end' }));
    }
</script>
</body>
</html>
